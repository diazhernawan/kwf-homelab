
---
Step 1 - Create a Priviledged LXC
---
**LXC Spec**
	OS: Debian 12
	General: Priviledged=1 Nesting=1
	Template:Debian 12
	Disk:32G
	CPU:4 cores
	Memory: 8192
	Network: Vlan Tag = 2 (IOT) DHCP=1

Edit LXC options
	Features: Nesting=1 NFS=1 SMB/CIFS=1 FUSE=1

Update the CT
```bash
apt-get update && apt-get upgrade -y
```


----
Step 2 - CONFIGURE SMB
---
 [[5. guide-smb-cifs-guide-debian-fstab]]

Install SMB/CIFS:
```bash
apt install cifs-utils -y
```

Create a folder in /mnt to mount the share:
```bash
mkdir /mnt/smb/Frigate -p
```

Create a hidden smb credentials file:
```bash
nano ~/.credentials.smb
```

fill smb credentials at ~/.credentials.smb:
```
user=diaz
password=brabus18
domain=katawarna.id
```

Edit the fstab file:
```bash
nano /etc/fstab
```

Mount SMB share for Frigate (at /etc/fstab):
```
//10.0.1.20/Raptor /mnt/smb/Raptor cifs uid=0,credentials=/home/diaz/.credentials.smb,iocharset=utf8,vers=3.0,noperm,nobrl 0 0
```

Reboot

Test Mount:
```
mount -a
cd /mnt/smb/Frigate
```

Poweroff


----
Step 3-  Configure intel iGPU passthrough for OpenVino**
---
In Proxmox shell navigate to LXC configuration directory:
```bash
cd /etc/pve/lxc/
```

Edit LXC configuration on Proxmox shell:
```
nano (lxc-id).conf
```

Add LXC configuration to allow LXC to access iGPU:
```
lxc.cgroup2.devices.allow: c 226:0 rwm
lxc.cgroup2.devices.allow: c 226:128 rwm
lxc.mount.entry: /dev/dri/renderD128 dev/dri/renderD128 none bind,optional,create=file 0, 0
lxc.mount.entry: /dev/dri dev/dri none bind,optional,create=dir
```

Start the LXC

Install intel gpu drivers:
```
apt install vainfo
apt install intel-gpu-tools
```

Check the igpu:
```
vainfo
intel_gpu_top
```


----
**C. Install Docker**
---
[[3. guide-docker-debian]] 

Update & Upgrade the LXC:
```
apt update && apt upgrade -y
```

Install Docker:
```
 apt install curl
 curl -fsSL https://get.docker.com -o get-docker.sh
 sh get-docker.sh
```

Verify that the installation is successful by running the hello-world image:
```
docker run hello-world
```


----
**D. Install Portainer**
---
[[4. guide-install-portainer]]

 Create Portainer docker volume:
```
docker volume create portainer_data
```

Install Portainer
```bash
docker run -d -p 8000:8000 -p 9443:9443 -p 9000:9000 --name portainer --restart=always -v /var/run/docker.sock:/var/run/docker.sock -v portainer_data:/data portainer/portainer-ce:latest
```


----
**E. Install Frigate**
---

Create docker volumes for docker stacks
```bash
mkdir docker_volumes
```

 Change Directory to docker_volumes and create Frigate Folder
```bash
mdkir frigate
cd frigate
```

Make frigate config.yml
```bash
nano config.yml
```

Fill config.yml with frigate dummy config
```yml
mqtt:
  enabled: False

cameras:
  dummy_camera: # <--- this will be changed to your actual camera later
    enabled: False
    ffmpeg:
      inputs:
        - path: rtsp://127.0.0.1:554/rtsp
          roles:
            - detect
```

Create frigate's docker-compose.yaml
```yaml
---
version: "3.9"
services:
  frigate:
    image: ghcr.io/blakeblackshear/frigate:stable
    container_name: frigate
    privileged: true # this may not be necessary for all setups
    restart: unless-stopped
    shm_size: "256mb" # update for your cameras based on calculation above
    devices:
      #- /dev/bus/usb:/dev/bus/usb # passes the USB Coral, needs to be modified for other versions
      #- /dev/apex_0:/dev/apex_0 # passes a PCIe Coral, follow driver instructions here https://coral.ai/docs/m2/get-started/#2a-on-linux
      - /dev/dri/renderD128 # for intel hwaccel, needs to be updated for your hardware
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /opt/frigate/config.yml:/config/config.yml
      - /mnt/smb/Frigate:/media/frigate
      - type: tmpfs # Optional: 1GB of memory, reduces SSD/SD Card wear
        target: /tmp/cache
        tmpfs:
          size: 1000000000
    ports:
      - "5000:5000"
      - "8554:8554" # RTSP feeds
      - "8555:8555/tcp" # WebRTC over tcp
      - "8555:8555/udp" # WebRTC over udp
    environment:
      FRIGATE_RTSP_PASSWORD: "password"
```

Pull the Frigate image: 
```
docker compose pull
```

Deploy the container: 
```
docker compose up -d --force-recreate
```

Monitor the logs to ensure the Frigate container is running as expected:
```
docker logs -f frigate
```

