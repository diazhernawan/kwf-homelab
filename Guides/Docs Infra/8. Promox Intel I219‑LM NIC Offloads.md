# Proxmox: Disabling Intel I219‑LM NIC Offloads (Persistent)

Automated guide for disabling problematic NIC offload features on a Lenovo M920x running Proxmox VE 8.4.1, using Intel I219‑LM (e1000e) network adapter.

---

## 🧠 Problem & Context

The Intel I219‑LM NIC (e1000e driver) on Proxmox VE can cause intermittent network failures (hardware unit hang) when offloading is enabled. Disabling offload features resolves stability issues.

---

## ✅ Current Setup

You have two systemd services configured to disable offload on boot:

1. **disable-eno1-offloads.service** *(inactive)*
2. **disable‑nic‑offload‑eno1.service** *(active)*

Only the latter runs successfully at boot and applies the ethtool offload disable commands.

---

## 🔧 Service File Content

### 1. Example of the active service (`/etc/systemd/system/disable‑nic‑offload‑eno1.service`):

```ini
[Unit]
Description=Disable NIC offloading for Intel e1000e interface eno1
Before=network-pre.target
Wants=network-pre.target

[Service]
Type=oneshot
ExecStart=/sbin/ethtool -K eno1 gso off gro off tso off rx off tx off sg off txvlan off rxvlan off

[Install]
WantedBy=multi‑user.target
```

---

## ⚙️ Offload Features Disabled

### 2. List of offload flags that are turned off:

* gso (generic segmentation offload)
* gro (generic receive offload)
* tso (TCP segmentation offload)
* tx, rx (checksum offloading)
* sg (scatter-gather)
* txvlan, rxvlan (VLAN offload)

*Use `ethtool -k eno1` to confirm settings are OFF.*

---

## 🛠 Status & Persistence

### 3. Check service status:

```bash
systemctl status disable-nic-offload-eno1.service
```

Should show `active (exited)` immediately after boot. That guarantees offload settings persist even without modifications to `/etc/network/interfaces`.

---

## 🧹 Optional Cleanup

### 4. If desired, clean up the old inactive service:

```bash
systemctl disable disable-eno1-offloads.service
rm /etc/systemd/system/disable-eno1-offloads.service
systemctl daemon-reload
```

---

## 📋 Quick Reference Table

| Step | Component                          | Status / Behavior                         | Remarks                      |
| ---- | ---------------------------------- | ----------------------------------------- | ---------------------------- |
| 1    | `disable-eno1-offloads.service`    | Inactive (dead)                           | Safe to remove               |
| 2    | `disable-nic-offload-eno1.service` | Active on boot, disables ethtool features | Your long-term fix in action |
| 3    | `ethtool -k eno1` output           | All relevant features OFF                 | Confirms stability settings  |

---

## 🧪 After Migration or Fresh Setup

### 5. To replicate this on a new server:

1. Copy service file to `/etc/systemd/system/`
2. Enable & reload:

   ```bash
   systemctl daemon-reload
   systemctl enable disable-nic-offload-eno1.service
   ```
3. Test by rebooting and verifying `ethtool -k eno1` outputs all offloads OFF.

---

## 🧾 Why This Works

Disabling offload avoids e1000e driver bugs seen with GSO/GRO/TSO and VLAN handling under high traffic conditions, preventing NIC hangs or dropped connectivity. This method ensures a reliable and repeatable setup.

---

Feel free to tweak paths or interface names (e.g. `enp0s31f6`) if your system uses alternate naming.
You’ve now got a documented, versioned network fix ready for future reference!
