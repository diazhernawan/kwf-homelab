
**guide-proxmox-8-pcie-passthrough**

---

First, find out if Proxmox is boothing using GRUB (Legacy BIOS) or Systemd (EFI boot).
During booting look at your screen:

- Blue - system is booting with GRUB
- Black - system is booting with Systemd (ZFS)

----
Step 1A - GRUB system add IMMOU support
---
Edit /etc/default/grub:
```bash
nano /etc/default/grub
```

Content /etc/default/grub:
```bash
GRUB_CMDLINE_LINUX_DEFAULT="quiet intel_iommu=on"
```
OR
```bash
GRUB_CMDLINE_LINUX_DEFAULT="quiet amd_iommu=on"
```

optional entry:
```bash
GRUB_CMDLINE_LINUX_DEFAULT="quiet intel_iommu=on iommu=pt pcie_acs_override=downstream,multifunction nofb nomodeset video=vesafb:off,efifb:off"
```

Save file and close.
Then update grub:
```bash
update-grub
```

---
STEP 1B - Systemd system (ZFS) add IMMOU
---
Edit /etc/kernel/cmdline:
```bash
nano /etc/kernel/cmdline
```

Content /etc/kernel/cmdline:
```bash
intel_iommu=on
```
OR
```bash
amd_iommu=on
```
	
Save file and close.
Then update proxmox-bootl-tool:
```bash
proxmox-boot-tool refresh
```

---

Step 2. Load VFIO modules at boot
---
Edit /etc/modules:
```bash
nano /etc/modules
```

Content /etc/modules:
```bash
vfio
vfio_iommu_type1
vfio_pci
vfio_virqfd
```

Save file and close




---
Step 3. Blacklist graphic drivers (optional)
---
Edit /etc/modprobe.d/iommu_unsafe_interrupts.conf & /etc/modprobe.d/kvm.conf:
```bash
echo "options vfio_iommu_type1 allow_unsafe_interrupts=1" > /etc/modprobe.d/iommu_unsafe_interrupts.conf
echo "options kvm ignore_msrs=1" > /etc/modprobe.d/kvm.conf
```

Edit /etc/modprobe.d/blacklist.conf:
```bash
echo "blacklist nouveau" >> /etc/modprobe.d/blacklist.conf
echo "blacklist nvidia" >> /etc/modprobe.d/blacklist.conf
echo "blacklist radeon" >> /etc/modprobe.d/blacklist.conf
```




---
Step 4 Configure GPU for PCIe Passthrough
---
Find your GPU / PCie device
```bash
lspci
```

Enter the PCI identifier
```bash
lspci -n -s 82:00 -v
```

Copy the HEX values from your GPU to /etc/modprobe.d/vfio.conf:
```bash
echo "options vfio-pci ids=####.####,####.#### disable_vga=1"> /etc/modprobe.d/vfio.conf
```

Apply all changes
Update-inirafs:
```bash
update-initramfs -u -k all
```

Reboot

---
Step 5. Verify PCIE PASSTHROUGH
---
Verify IOMMU is enabled
```bash
dmesg | grep -e DMAR -e IOMMU
```

There should be a line that looks like "DMAR: IOMMU enabled". If there is no output, something is wrong.

Verify IOMMU interrupt remapping is enabled:

```bash
dmesg | grep 'remapping'	
```

If you see one of the following lines: then remapping is supported.
```bash
AMD-Vi: Interrupt remapping enabled
DMAR-IR: Enabled IRQ remapping in x2apic mode ('x2apic' can be different on old CPUs, but should still work)
```

	Reboot & ready for device passthrough.


# Guide & Docs

Guide:
```	
https://www.youtube.com/watch?v=_hOBAGKLQkI&t=434s
```

```
https://www.youtube.com/watch?v=BoMlfk397h0&t=1612s
```

```
https://pve.proxmox.com/wiki/PCI(e)_Passthrough
````

Verify PCIE Passthtrough documentation:
```
https://pve.proxmox.com/wiki/PCI_Passthrough#Verifying_IOMMU_parameters
```

```
https://www.reddit.com/r/homelab/comments/b5xpua/the_ultimate_beginners_guide_to_gpu_passthrough/
```
